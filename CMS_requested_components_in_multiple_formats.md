# CMS Requested Components in Multiple Formats

## Problem Overview

Optimizely CMS was requesting components in multiple different formats, causing "Component not resolved by factory" errors. The CMS would request components like:

- `Item/Page/StandardTwoCoulmnPage`
- `Item/Component/VelocityHeroBanner`
- `Component/Item/Component/ThoughtLeadershipArticleBlock`
- `Item/Page/Experience/BlankExperience`

However, components were only registered in standard formats:

- `Page/StandardTwoCoulmnPage`
- `Component/VelocityHeroBanner`
- `Component/ThoughtLeadershipArticleBlock`
- `Page/Experience/BlankExperience`

This mismatch caused component resolution failures.

## Initial Approach (Not Ideal)

Initially, we tried to register components in all possible variations:

- Original: `Component/ThoughtLeadershipArticleBlock`
- Item-prefixed: `Item/Component/ThoughtLeadershipArticleBlock`
- Item-inserted: `Component/Item/Component/ThoughtLeadershipArticleBlock`

This approach:
- Required maintaining duplicate registrations for every component
- Was hard to maintain and scale
- Added ~100+ lines of duplicate code
- Would break if Optimizely introduced new formats

## Final Solution: Normalization Wrapper

We implemented a **normalization wrapper** that automatically converts any component type format to the standard format before lookup.

### How It Works

1. **Normalization Function** (`normalizeComponentType`):
   - Removes `Item/` prefixes
   - Removes `Item` segments from anywhere in the path
   - Removes duplicate consecutive prefixes (e.g., `Component/Component` → `Component`)
   - Handles both string and array type formats

2. **Wrapper Class** (`NormalizingComponentFactory`):
   - Implements the `ComponentFactory` interface
   - Intercepts `resolve()` and `has()` calls
   - Normalizes the component type before delegating to the base factory
   - Other methods (`register`, `registerAll`, `extract`) pass through unchanged

### Example Transformations

```
Item/Component/ThoughtLeadershipArticleBlock
  → Component/ThoughtLeadershipArticleBlock ✓
Component/Item/Component/ThoughtLeadershipArticleBlock
  → Component/ThoughtLeadershipArticleBlock ✓
Item/Page/StandardTwoCoulmnPage
  → Page/StandardTwoCoulmnPage ✓
Item/Page/Experience/BlankExperience
  → Page/Experience/BlankExperience ✓
```

## Implementation

### Code Structure

```typescript
// 1. Create base factory with standard registrations
const baseFactory = new DefaultComponentFactory()
baseFactory.registerAll(cmsComponents) // Only standard formats

// 2. Create wrapper that normalizes requests
class NormalizingComponentFactory {
    resolve(type: string | string[]): any {
        const normalized = normalizeComponentType(type) // Transform here
        return this.base.resolve(normalized) // Lookup in standard format
    }
}

// 3. Export the wrapper as the factory
export const factory = new NormalizingComponentFactory(baseFactory)
```

### Files Changed

1. **`apps/frontend/src/components/factory.ts`**:
   - Added `normalizeComponentType()` function
   - Created `NormalizingComponentFactory` wrapper class
   - Wrapped the base factory with normalization

2. **`apps/frontend/src/components/cms/index.ts`** (Auto-generated):
   - ⚠️ **Note**: This file is auto-generated by the CLI tool
   - The normalization wrapper handles format variations automatically
   - **No manual changes needed** - the wrapper works regardless of what's in the generated file
   - The generated file can contain any format, and normalization will still work

## Benefits

1. ✅ **Single Source of Truth**: Components registered once in standard format
2. ✅ **Automatic Handling**: Any format Optimizely sends gets normalized automatically
3. ✅ **Maintainable**: No duplicate registrations to maintain
4. ✅ **Future-Proof**: Handles new formats Optimizely might introduce automatically
5. ✅ **Clean Code**: Removed ~100+ lines of duplicate registration code

## Result

- ✅ Components resolve correctly regardless of format Optimizely sends
- ✅ Build passes successfully
- ✅ Code is cleaner and easier to maintain
- ✅ No more "Component not resolved by factory" errors
- ✅ **Works with auto-generated files** - normalization happens at factory level, so regenerated files don't break the solution

## Important Note: Auto-Generated Files

The file `apps/frontend/src/components/cms/index.ts` is **auto-generated** by the Optimizely CLI tool. This means:

- ✅ **No manual changes needed** - The normalization wrapper in `factory.ts` handles everything automatically
- ✅ **Regeneration safe** - Even if the CLI regenerates the file with different formats, the normalization wrapper will still work
- ✅ **Future-proof** - New components added via CLI will automatically benefit from normalization

The solution centralizes normalization at the factory level, so all component lookups automatically use the standard format, regardless of:
- How Optimizely requests them
- What format the auto-generated files use
- Whether files are regenerated